@model Rentler.Web.Models.ListingIndexModel
@section title { Rentler - Listing - @Model.FullAddress }
@section css {
    <link href="/css/scrim.css?v=@Html.BuildNumber()" rel="Stylesheet" />
    <link href="/css/pages/listing.css?v=@Html.BuildNumber()" rel="Stylesheet" />
}

<div class="container">
    <div class="listingLeft">
    <div id="reportedMessageBox" style="display: @(Model.Listing.IsReported ? "block" : "none")">This listing has been flagged and will be reviewed by Rentler</div>
    
    @if (Model.Listing.User.Username == User.Identity.Name)
    {
	    <div class="landlordBox">
		    <div class="manage">
			    <a href="/dashboard/unit/view/@Model.Listing.BuildingId" class="button green">Manage This Unit</a>	
		    </div>
		    <h1>Your listing has been created</h1>
		    <p>A preview of your @(Model.Listing.IsActive ? "active" : "inactive") listing is below.</p>
	    </div>
    }             
     
    @if (!string.IsNullOrWhiteSpace(Model.Listing.Title))
    {
        <div class="listingTitleContainer">
            <span class="listingTitle">@Model.Listing.Title</span>
        </div>
    }
     
        @* Block shown on both the map and the listing Image *@
        @* Map Information *@
        <div id="map" class="map">&nbsp;</div>
        <div class="darkHeading">
            <a id="openMap" rel="nofollow" target="_blank" href="@Html.GoogleMapsLink(Model.FullAddress, Model.Listing.Latitude, Model.Listing.Longitude)" class="subHeading">Open Map in New Window</a>
            <a id="closeMap" href="#" class="back">Back to Listing</a>
        </div>

        @* General listing information *@        
        <div class="listingImageBlock">            
            <div class="listingOverlay scrim" style="display:none;">&nbsp;</div>
            <div class="listingOverlay" style="display:none;"> 
                <div class="plusImage">&nbsp;</div> 
                <div>View Full Size</div> 
            </div>            

            <div class="closeBlock"><a href="#" class="button closeImage"></a></div>

        @* TODO: figure out how to get ribbon path
        @if(!string.IsNullOrWhiteSpace(Model.Listing.RibbonId)) 
        {
            <img class="ribbonOverlay" src="@Rentler.Helpers.RibbonHelper.GetSmallLink(@Model.Detail.Building.RibbonId.Value)" alt="" width="161" height="54" />
        }
        *@

            <div class="listingImage">
                <img src="@Html.GetPhotoLink(Model.Listing.BuildingId, Model.Listing.PrimaryPhotoId, 280, 190, Model.Listing.PrimaryPhotoExtension)" alt="image" />
            </div>

        @if (Model.Listing.Photos.Any())
        {
            <div class="listingImageScroller">
                <div class="leftScroll">
                    <button></button>
                </div>
                <div class="scrollContainer">
                    <ul class="smallScroller">
                    @foreach (var item in Model.Listing.Photos)
                    {
                        <li>
                            <a href="#">
                                <img src="@Html.GetPhotoLink(item.BuildingId, item.PhotoId, 50, 50, item.Extension)" alt="image" />
                            </a>
                        </li>
                    }
                    </ul>
                </div>
                <div class="rightScroll">
                    <button></button>
                </div>
            </div>
        }
    </div>
    
    <div class="listingInformation">
        <div class="infoSection">
            <span class="listingPrice">@string.Format("{0:C2}", Model.Listing.Price)</span>
            <span class="listingPriceLabel">Per Month</span>
        </div>
        <div class="infoSection clr">
            <p id="listingDesc">@Html.Raw(Model.Listing.Description)</p>
        </div>       
    </div>

    <div class="generalInfo">
        <div class="bedBathStatInfo right">
            <ul class="bedBathStats">
                <li class="first">
                    <div class="count">@Model.Listing.Bedrooms.ToString()</div>
                    <div class="label">Bed</div>
                </li>
                <li>
                    <div class="count">@string.Format("{0:0.##}", Model.Listing.Bathrooms)</div>
                    <div class="label">Bath</div>
                </li>
                <li>
                    <div class="count">@Model.Listing.YearBuilt</div>
                    <div class="label">Year</div>
                </li>
                <li>
                    <div class="count">@Model.Listing.SquareFeet</div>
                    <div class="label">SqFt</div>
                </li>
                <li>
                    <div class="count">@string.Format("{0:0.##}", @Model.Listing.Acres)</div>
                    <div class="label">Acres</div>
                </li>                
            </ul>  
        </div>
        <div class="clr listingAddress">
            <div class="address">
                <div class="line1">@Model.Listing.Address1 </div>
                <div class="line2">@Model.Listing.City, @Model.Listing.State @Model.Listing.Zip</div>
            </div>
            <div class="inlineSection mapIt">
                <a href="#" class="button mapIcon"></a>
            </div>                                
            <div style="clear:both;"></div>
        </div>
        <div style="clear:both;"></div>
    </div>

    <div class="lightHeading">        
    @if (Model.Listing.DateAvailableUtc == null ||
        Model.Listing.DateAvailableUtc.Value.Ticks < DateTime.UtcNow.Ticks)
    {
		<span style="float:right;">Unit Available</span>
    }
    else
    {
		<span style="float:right;">Unit Available: @Model.Listing.DateAvailableUtc.Value.ToLocalTime().ToShortDateString()</span>
    } 
        Listing Details       
        <div style="clear:right;"></div>
    </div>
    <div class="detailsInfo">
        <div class="contactInfo">
            <div class="heading">Landlord Contact Information</div>
            <ul>
                <li>@Model.Listing.ContactInfo.Name</li>
            @if (!string.IsNullOrWhiteSpace(Model.Listing.ContactInfo.CompanyName))
            {
                <li>@Model.Listing.ContactInfo.CompanyName</li>
            }
            @if (Model.Listing.ContactInfo.ShowPhoneNumber)
            {
                <li class="phoneNumber">@Model.Listing.ContactInfo.PhoneNumber</li>
            }
            @if (Model.Listing.ContactInfo.ShowEmailAddress)
            {
                <li>@Model.Listing.ContactInfo.Email</li>
            }
            </ul>
            <ul class="actionList interestInfo">
                <li class="iminterested">
                    <a href="#interested" id="interested" class="button green" data-id="@Model.Listing.BuildingId">I'm Interested</a>
                </li>
                <li class="first">
                    <div>
						<a href="#" rel="nofollow" id="saveListing" class="button @(Model.UserHasSaved ? "saved" : "save")" data-id="@Model.Listing.BuildingId"></a>
                    </div>
                    <div class="label">@(Model.UserHasSaved ? "Saved" : "Save")</div>
                </li>
                <li>
                    <div>
                        <a href="#" id="addthisButton" class="button share" data-pubId="@Rentler.Web.Config.AddThisPubId"></a>
                    </div>
                    <div class="label">Share</div>
                </li>                
            </ul>
        </div>
        <div class="listingInfo">
            <div class="heading">@Model.Listing.PropertyType</div>
            <ul>
                <li><span>Ad Number:</span>@Model.Listing.BuildingId</li>
                <li><span>Post Date:</span>@(Model.Listing.DateActivatedUtc.HasValue ? Model.Listing.DateActivatedUtc.Value.ToLocalTime().ToShortDateString() : "?")</li>
                <li><span>Expiration Date:</span>@(Model.ExpirationDate.HasValue ? Model.ExpirationDate.Value.ToShortDateString() : "?")</li>
                <li><span>Time Online:</span>@Html.FriendlyTimeSpan(Model.TimeOnline)</li>
                <li><span>Time Left:</span>@Html.FriendlyTimeSpan(Model.TimeLeft)</li>
                <li><span>List Type:</span>@Model.Listing.ContactInfo.ContactInfoType</li>
                <li><span>Page Views:</span>@Model.ListingViews</li>
            </ul>
        </div>
        <div style="clear:left;"></div>
    </div>

    <div class="lightHeading">Amenities</div>
    <div class="amenitiesList">        
        <ul>            			
            @foreach (var key in Rentler.Configuration.Amenities.Current.Property.Keys)
            {
                bool isSelected = Model.Listing.BuildingAmenities.Any(a => a.AmenityId == key);               
                <li class="@(isSelected ? "active" : "inactive")">@Rentler.Configuration.Amenities.Current.Property[key]</li>
            }

            @foreach (var key in Rentler.Configuration.Amenities.Current.OptionsProperties.Keys)
            {
                var options = Rentler.Configuration.Amenities.Current.OptionsProperties[key];                
                var results = options.Keys.Intersect(Model.Listing.BuildingAmenities.Select(a => a.AmenityId));                
                if(results.Count() > 0) 
                {
                    <li class="active">@string.Format("{0} : {1}", key, options[results.First()])</li>
                }                
            }        					                         
        </ul>
    </div>

    <div class="lightHeading" style="clear:left;">Community Amenities</div>
    <div class="amenitiesList">
        <ul>            			
            @foreach (var key in Rentler.Configuration.Amenities.Current.Community.Keys)
            {
                bool isSelected = Model.Listing.BuildingAmenities.Any(a => a.AmenityId == key);              
                
                <li class="@(isSelected ? "active" : "inactive")">@Rentler.Configuration.Amenities.Current.Community[key]</li>
            }  
            
            @foreach (var key in Rentler.Configuration.Amenities.Current.OptionsCommunity.Keys)
            {
                var options = Rentler.Configuration.Amenities.Current.OptionsCommunity[key];
                
                var results = options.Keys.Intersect(Model.Listing.BuildingAmenities.Select(a => a.AmenityId));
                
                if(results.Count() > 0) 
                {
                    <li class="active">@string.Format("{0} : {1}", key, options[results.First()])</li>
                }
            }         
        </ul>        
    </div>

    @if (Model.Listing.CustomAmenities.Count > 0)
    {
    <div class="lightHeading" style="clear:left;">Additional Features</div>
    <div class="amenitiesList">
        <ul>            			
            @foreach (var item in Model.Listing.CustomAmenities)
            {
                <li class="active">@item.Name</li>
            }             
        </ul>        
    </div>
    }
    <div id="reportListingContainer">         
        <a href="/listing/report/@Model.Listing.BuildingId" id="reportListing" data-id="@Model.Listing.BuildingId">Report Listing</a>        
    </div>
</div>
@* End of left column *@

@* Right column for all the searching result information *@
<div class="listingRight">
    @*<div class="listingSearchResults">
        <div class="listingSearchHeading">
			Related Search Results
        </div>
        <div>
            <button class="button listingSearchScrollTop"></button>
        </div>
        <div class="listingResultsContainer">
            <ul class="actualResults"></ul>
        </div>
        <div>
            <button class="button listingSearchScrollBottom"></button>
        </div> 
    </div>*@ 
</div>

<form action="#" method="post" class="hide">
    <input id="listingId" type="hidden" value="@Model.Listing.BuildingId" />
    <input id="lat" type="hidden" value="@Model.Listing.Latitude" />
    <input id="lng" type="hidden" value="@Model.Listing.Longitude" />
</form>
</div>

@section js {
    <script type="text/javascript">
        var globalListingId = @Model.Listing.BuildingId;
    </script>
    <script src="https://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="/scripts/amplify.min.js"></script>
    <script type="text/javascript" src="/scripts/knockout-2.1.0.js"></script>
	<script type="text/javascript" src="/scripts/jcarousellite.js"></script>
    <script type="text/javascript" src="/js/api/rentler.api.listings.js?v=@Html.BuildNumber()"></script>
	<script type="text/javascript" src="/js/api/rentler.api.auth.js?@Html.BuildNumber()"></script>
    <script type="text/javascript" src="/js/rentler.listing.js?v=@Html.BuildNumber()"></script>
}